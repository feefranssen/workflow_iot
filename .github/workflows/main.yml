name: Feest

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Build Docker image (ARM)
      - name: Build ARM Docker image
        run: |
          docker build -t feest_builder --platform=linux/arm .

      # 3️⃣ Compile inside ARM container
      - name: Compile code inside ARM container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/work \
            --platform=linux/arm \
            feest_builder \
            bash -c "
              cd /work &&
              gcc -c pigpio/*.c &&
              ar rcs libpigpio.a *.o &&
              gcc main.c -L. -lpigpio -o main
            "

      # 4️⃣ Save compiled executable as GitHub artifact (OPTIONEEL)
      - name: Store executable
        uses: actions/upload-artifact@v4
        with:
          name: main
          path: ./main

      # 5️⃣ Install SSH client
      - name: Install SSH client
        run: sudo apt-get install -y openssh-client

      # 6️⃣ Copy executable to Raspberry Pi
      - name: Upload executable to Raspberry Pi
        run: |
          scp -o StrictHostKeyChecking=no \
            main \
            ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:/home/${{ secrets.PI_USER }}/main

      # 7️⃣ Restart program via tmux on the Pi
      - name: Restart app via tmux
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} << 'EOF'
              cd /home/${{ secrets.PI_USER }}

              chmod +x main

              # Kill old session if running
              tmux kill-session -t feest || true

              # Start new session
              tmux new -d -s feest "sudo /home/${{ secrets.PI_USER }}/main"
          EOF
