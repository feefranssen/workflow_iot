name: Deploy to Raspberry Pi

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Build Docker container for compile environment
      - name: Build Docker image
        run: |
          docker build -t pi-build-env .

      # 3️⃣ Compile code inside the Docker container
      - name: Compile code inside container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/src \
            pi-build-env \
            bash -c "cd /src && make"

      # 4️⃣ Upload compiled executable as an artifact (optioneel)
      - name: Store artifact
        uses: actions/upload-artifact@v4
        with:
          name: pi-executable
          path: ./build/your_executable_name

      # 5️⃣ Install SSH client (nodig voor scp & ssh)
      - name: Install SSH
        run: sudo apt-get install -y openssh-client

      # 6️⃣ Copy executable naar Raspberry Pi
      - name: Upload executable to Raspberry Pi via SCP
        run: |
          scp -o StrictHostKeyChecking=no \
            ./build/your_executable_name \
            ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:/home/${{ secrets.PI_USER }}/app/

      # 7️⃣ Stop running program, start the new one via tmux
      - name: Restart program on Raspberry Pi
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} << 'EOF'
              tmux kill-session -t app || true
              tmux new -d -s app '/home/${{ secrets.PI_USER }}/app/your_executable_name'
          EOF
